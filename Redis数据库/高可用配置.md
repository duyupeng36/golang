# redis高可用

在 WEB 服务器中，**高可用**是指**服务器正常访问的时间**，衡量标准在**多长时间内可以提供正常服务**。

在 Redis 层面，**高可用**除了保证提供**正常服务(主从分离、快速容灾技术等)**，还需要考虑**数据容量扩展、数据安全**等

在 Redis 中，实现**高可用**的技术主要包括**持久化、复制、哨兵、集群**

* **持久化**: 持久化是 *最简单* 的高可用方法。主要作用是**数据备份**，即将数据存储在硬盘，保证数据不会因进程退出而丢失

* **复制**: 复制是redis高可用的基础，**哨兵**和**集群**都是在**复制的基础**上实现的高可用。复制主要实现了数据的多机备份以及
  对于读操作的负载均衡和简单的故障恢复。缺陷是故障恢复无法自动化，写操作无法负载均衡，存储受到单机的限制

* **哨兵**: 复制基础上，哨兵实现了**自动化的故障恢复**。 缺陷是 **写操作** 无法负载均衡，存储能力收单机限制
    * 在每台redis服务器上启动哨兵进程，从服务器哨兵监控主服务器哨兵；当主服务器哨兵宕机后，从服务器哨兵会选择一个从服务器作为主服务器

* **集群**: 通过集群，redis解决了写操作无法负载均衡以及存储能力受单机限制问题，实现了完善的高可用方案


## 数据持久化

数据持久化的方式有两种: `rdb`和`aof`

### `rdb`方式

```shell
save 900 1  # 900s内有1次更新，就会持久化
save 300 10 # 300s内有10次更新，就会持久化
save 60 10000  # 60s内有10000次更新，就会持久化
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb  # 数据保存的文件
dir ./  # 数据保存的目录
```

* **优点**
    - 生成二进制文件
    - 系统会默认的多长时间保存一次
    - 直接手动保存
    - 制作快照
    - 可以用作备份
    - 比较适合做灾难恢复
    - 主进程会`fork`一个子进程出来，子进程用来负责保存数据

* **缺点**
    - 如果说数据需要 *尽量保存* 下来，则不适合实用rdb
    - 在数据量庞大的时候，对系统消耗过大

* `save` 保存数据

* `flushall` 删除数据
* `flushdatabase`

### `aof`方式

- **优点**
    - 持久化更好, 数据实时保存
    - `aof`将所有的操作都追加到一个文件中，`redis-check-aof`修复`aof`文件
    - 文件易读

- **缺点**
    - 文件会越来越大
    - `aof`的速度会比`rdb`慢，`aof`使用的是`fsync`
    - 文件易读

`aof`数据持久化配置

```shell
appendonly yes
appendfilename "appendonly.aof"  # aof文件，保存的是执行过的命令
appendfsync everysec  # 每秒添加
```

## redis主从复制

只需要在**从服务器**上进行配置(在redis配置文件中添加)

```shell
slaveof ip port  # 指定主服务器的ip和端口
masterauth <password>  # 验证主服务器密码，没有密码则不需要
```

`config set masterauth password`: 从服务器执行，校验主服务器密码

- **基于异步**的，平均每秒钟从服务器都会主服务器发送复制的情况
- 一个主可以多个从
- 不止主服务器可以有从服务器，从服务器也可以有从服务器
- 复制功能不会阻塞主服务器
- 复制功能也不会阻塞从服务器


## 哨兵

`Redis Sentinel` 是 `Redis` 高可用 的实现方案。`Sentinel` 是一个管理多个 `Redis` 实例的工具， 它可以实现对 `Redis` 的 **监控、通知、自动故障转移**
。下面先对 `Redis Sentinel` 的 **基本概念** 进行简单的介绍。

<div class="table-box"><table><thead><tr><th>基本名词</th><th>逻辑结构</th><th>物理结构</th></tr></thead><tbody><tr><td>Redis数据节点</td><td>主节点和从节点</td><td>主节点和从节点的进程</td></tr><tr><td>主节点(master)</td><td>Redis主数据库</td><td>一个独立的Redis进程</td></tr><tr><td>从节点(slave)</td><td>Redis从数据库</td><td>一个独立的Redis进程</td></tr><tr><td>Sentinel节点</td><td>监控Redis数据节点</td><td>一个独立的Sentinel进程</td></tr><tr><td>Sentinel节点集合</td><td>若干Sentinel节点的抽象组合</td><td>若干Sentinel节点进程</td></tr><tr><td>Redis Sentinel</td><td>Redis高可用实现方案</td><td>Sentinel节点集合和Redis数据节点进程</td></tr><tr><td>应用客户端</td><td>泛指一个或多个客户端</td><td>一个或者多个客户端进程或者线程</td></tr></tbody></table></div>



